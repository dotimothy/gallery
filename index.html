<!DOCTYPE html>
<html>
    <base target="_blank"/>
    <head>
        <title>Gallery Template</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📷</text></svg>">
        <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    </head>

    <style>
        body { background-color: black; }
        h1, h2, p { color: white; font-family: 'Roboto', sans-serif; }
        h1 { font-size: 3em; font-weight: bolder; }
        h2 { font-size: 2em; }
        p { font-size: 1.5em; font-weight: lighter; }
        a { color: #007bff; transition: 0.1s; }
        a:hover { opacity: 0.7; transition: 0.1s; }
        #gallery { display: inline-block; width: 100%; text-align: center; }
        .thumbhidden { width: calc(100%/5); opacity: 0%; }
        .thumb {
            width: calc(100%/5);
            animation: fadein 0.25s forwards;
            opacity: 100%;
            cursor: pointer;
            transition: opacity 0.1s, width 0.3s ease-in-out, filter 0.1s ease-in-out, box-shadow 0.1s ease-in-out, transform 0.1s ease-in-out;
            border-radius: 5px;
            box-sizing: border-box;
            padding: 5px;
        }
        .thumb:hover {
            opacity: 1;
            filter: brightness(1.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transform: scale(1.02);
        }
        @keyframes fadein {
            0% {opacity: 0%;}
            100% {opacity: 100%;}
        }
        button {
            font-size: 6em;
            background-color: transparent;
            border: none;
            opacity: 0.5;
            transition: 0.1s;
            user-select: none;
            color: white;
            cursor: pointer;
            padding: 0.1em 0.2em;
            border-radius: 8px;
        }
        button:hover { opacity: 1; transition: 0.1s; }
        button:active { transform: translateY(3px); transition: 0.05s; }
        #imageViewer {
            position: fixed;
            top: 0; left: 0;
            background-color: rgba(0,0,0,0.9);
            width: 100%; height: 100%;
            margin: 0; padding: 0;
            z-index: 1;
            user-select: none;
            overflow: hidden;
            touch-action: none;
        }
        #imageViewer.visible { animation: grow 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #imageViewer.shrinking { animation: shrink 0.3s forwards; }
        @keyframes grow {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes shrink {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(0.5); opacity: 0; }
        }
        #full {
            position: absolute;
            width: 100%; height: 100%;
            max-height: calc(100% - 90px);
            object-fit: contain;
            user-select: none;
            pointer-events: none;
            cursor: default;
            transform-origin: center center;
            transition: opacity 0.1s ease-in-out;
        }
        #full.thumbs-hidden { max-height: 100%; }
        @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 1; } to { transform: translateX(0); opacity: 1; } }
        .slide-out-left { animation: slideOutLeft 0.3s ease-out forwards; }
        .slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        .slide-out-right { animation: slideOutRight 0.3s ease-out forwards; }
        .slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        #metadataViewer {
            position: fixed;
            background-color: rgba(0,0,0,0.8);
            width: 100%;
            max-height: 35%; /* Adjusted from 28% */
            bottom: 90px;
            opacity: 0%;
            z-index: 2;
            line-height: 1.4em;
            padding-bottom: 10px;
            box-sizing: border-box;
            transition: opacity 0.2s ease-in-out, bottom 0.3s ease-in-out;
            overflow-y: auto;
            color: white;
            padding: 15px 20px;
            font-family: 'Roboto', sans-serif;
            text-align: center;
        }
        #metadataViewer.active { opacity: 0.9; }
        #metadataViewer.thumbs-hidden { bottom: 0; }
        #exitViewer { position: fixed; font-size: 2.5em; top: 15px; right: 15px; z-index: 3; }
        #home { position: fixed; font-size: 2.5em; bottom: 15px; right: 15px; z-index: 3; }
        #leftArrow { position: fixed; font-size: 4em; color: white; bottom: 45%; left: 5%; z-index: 3; }
        #rightArrow { position: fixed; font-size: 4em; color: white; bottom: 45%; right: 5%; z-index: 3; }
        #toggleMetadata { position: fixed; font-size: 2.5em; color: white; top: 15px; left: 15px; z-index: 3; line-height: 1; }
        #fullscreenToggle { position: fixed; font-size: 2.5em; color: white; top: 15px; left: 70px; z-index: 3; line-height: 1; }
        #toggleThumbSelector { position: fixed; font-size: 2.5em; color: white; top: 15px; left: 125px; z-index: 3; line-height: 1; }
        #exitViewer, #toggleMetadata, #home, #leftArrow, #rightArrow, #fullscreenToggle, #toggleThumbSelector {
          opacity: 0.6;
          text-shadow: 0px 0px 10px rgba(0,0,0,0.7);
          transition: opacity 0.2s ease;
        }
        #exitViewer:hover, #toggleMetadata:hover, #home:hover, #leftArrow:hover, #rightArrow:hover, #fullscreenToggle:hover, #toggleThumbSelector:hover { opacity: 1; }
        #fullViewThumbSelector {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%; height: 90px;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            z-index: 4;
            padding: 5px 10px;
            box-sizing: border-box;
            scroll-behavior: smooth;
            transition: transform 0.3s ease-in-out;
        }
        #fullViewThumbSelector.hidden-thumbs { transform: translateY(100%); }
        #fullViewThumbSelector img {
            flex-shrink: 0;
            height: 80px;
            width: auto;
            min-width: 80px;
            object-fit: cover;
            margin: 0 5px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 3px;
            transition: border-color 0.1s ease-in-out, transform 0.1s ease-in-out;
        }
        #fullViewThumbSelector img:hover { border-color: #ccc; transform: scale(1.05); }
        #fullViewThumbSelector img.activeFullViewThumb {
            border-color: #007bff;
            box-shadow: 0 0 8px #007bff;
            transform: scale(1.05);
        }
        @media (max-width: 1280px) { .thumb, .thumbhidden { width: calc(100%/4); } }
        @media (max-width: 1024px) {
            .thumb, .thumbhidden { width: calc(100%/3); }
            h1 { font-size: 2.5em; }
            h2 { font-size: 1.8em; }
            p { font-size: 1.2em; }
        }
        @media (max-width: 767px) {
            h1 { font-size: 1.8em; text-align: center; }
            .thumb, .thumbhidden { width: calc(100%/2); }
            #fullViewThumbSelector { height: 70px; }
            #fullViewThumbSelector img { height: 60px; min-width: 60px; }
            #full { max-height: calc(100% - 70px); }
            #full.thumbs-hidden { max-height: 100%; }
            #metadataViewer { bottom: 70px; max-height: 45%; /* Adjusted from 38% */ text-align: left; padding: 10px 15px; }
            #metadataViewer.thumbs-hidden { bottom: 0; }
            #metadataViewer h2 { font-size: 1.2em; }
            #metadataViewer p { font-size: 0.9em; line-height: 1.5; }
            #exitViewer, #toggleMetadata, #home, #fullscreenToggle, #toggleThumbSelector { font-size: 2.2em; }
            #leftArrow, #rightArrow { font-size: 3em; }
        }

        /* Styles for the new light pollution map iframe modal */
        #lightPollutionMapOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        #lightPollutionMapOverlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #lightPollutionMapContainer {
            position: relative;
            width: 90%;
            max-width: 800px;
            height: 80%;
            max-height: 600px;
            background-color: black;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease-in-out;
        }

        #lightPollutionMapOverlay.visible #lightPollutionMapContainer {
            transform: scale(1);
            opacity: 1;
        }

        #lightPollutionMapIframe {
            width: 100%;
            height: calc(100% - 40px); /* Adjust height for close button */
            border: none;
        }

        #lightPollutionMapCloseButton {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            transition: background-color 0.2s;
        }

        #lightPollutionMapCloseButton:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
    </style>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let doFullscreen = (isMobileDevice() && urlParams.has('fullscreen')) || (!isMobileDevice() && (!urlParams.has('fullscreen')));
        let debug = urlParams.has('debug');
        let dataSaver = urlParams.has('datasaver');
        let fullDir = dataSaver ? 'thumbs' : 'fulls'; 
        let preload = urlParams.has('preload');
        let galleryView = urlParams.has('gallery');
        let gallery, imageViewer, metadata = {}, imgNames = [];
        let revealInterval, revealCounter = 0, galleryCounter = 0, galleryDuration = 1500, galleryInterval;
        let isMobile, keyAction, swipeThresh = 75, touchstartX = 0, touchendX = 0, madeFullscreen = false;
        let titleElement, j = 0;
        const completedTitle = `📷 Gallery Template!!! �`;
        let homeButton; 

        let currentScale = 1.0, currentPanX = 0, currentPanY = 0, isPanningImage = false;
        let lastPanMouseX = 0, lastPanMouseY = 0, fullImageElement = null;
        const MIN_SCALE = 1.0, MAX_SCALE = 8.0, ZOOM_INTENSITY = 0.1;

        let initialPinchDistance = 0, initialScale = 1.0, lastTouchX = 0, lastTouchY = 0, isTwoFingerPanning = false;
        let thumbSelectorVisible = true;

        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        function preloadFulls() {
            for(let i = 0; i < imgNames.length; i++) {
                new Image().src = `./${fullDir}/${imgNames[i]}.jpg`;
            }
        }

        function getJSONData(url) {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, false);
            try {
                xhr.send();
                return xhr.status === 200 ? JSON.parse(xhr.responseText) : null;
            } catch (error) {
                console.error('Error fetching JSON:', error);
                return null;
            }
        }

        function loadMetadata() {
            const allData = getJSONData('./metadata/metadata.json');
            if (allData) {
                metadata = allData;
                imgNames = allData.image_order || [];
            } else {
                console.error("Failed to load metadata.json. Metadata and image list will be unavailable.");
                metadata = {};
                imgNames = [];
            }
        }

        function loadThumbs() {
            for (let i = 0; i < imgNames.length; i++) {
                const imgElement = document.createElement('img');
                imgElement.onclick = () => viewFull(imgNames[i]);
                imgElement.id = imgNames[i];
                imgElement.src = `./thumbs/${imgNames[i]}.jpg`;
                imgElement.classList.add('thumbhidden');
                imgElement.alt = imgNames[i];
                gallery.appendChild(imgElement);
            }
            document.querySelector('footer').hidden = false;
        }

        function revealThumb(imgName) {
            let img = document.getElementById(imgName);
            if (img) {
                img.classList.remove('thumbhidden');
                img.classList.add('thumb');
            }
        }

        function revealThumbs() {
            if(revealCounter < imgNames.length) {
                revealThumb(imgNames[revealCounter]);
                revealCounter++;
            } else {
                clearInterval(revealInterval);
            }
        }

        function checkDirection() { return touchendX < touchstartX; }
        function checkLength() { return Math.abs(touchstartX-touchendX) >= swipeThresh; }

        function applyTransformations() {
            if (fullImageElement) fullImageElement.style.transform = `translate(${currentPanX}px, ${currentPanY}px) scale(${currentScale})`;
        }

        function constrainPan() {
            if (!fullImageElement || !imageViewer) return;
            const imgBoxWidth = fullImageElement.offsetWidth, imgBoxHeight = fullImageElement.offsetHeight;
            const scaledContentWidth = imgBoxWidth * currentScale, scaledContentHeight = imgBoxHeight * currentScale;
            const viewerWidth = imageViewer.clientWidth, viewerHeight = imageViewer.clientHeight;
            const maxX = Math.max(0, (scaledContentWidth - viewerWidth) / 2);
            const maxY = Math.max(0, (scaledContentHeight - viewerHeight) / 2);
            currentPanX = Math.max(-maxX, Math.min(maxX, currentPanX));
            currentPanY = Math.max(-maxY, Math.min(maxY, currentPanY));
        }

        function handleWheelZoom(event) {
            if (!fullImageElement) return;
            event.preventDefault();
            const oldScale = currentScale;
            const rect = imageViewer.getBoundingClientRect();
            const mouseX = event.clientX - rect.left, mouseY = event.clientY - rect.top;

            currentScale = event.deltaY < 0 ? Math.min(MAX_SCALE, currentScale * (1 + ZOOM_INTENSITY)) : Math.max(MIN_SCALE, currentScale * (1 - ZOOM_INTENSITY));

            if (currentScale <= MIN_SCALE) {
                currentScale = MIN_SCALE;
                resetZoomAndPan(false);
            } else {
                const imageViewerCenterX = rect.width / 2, imageViewerCenterY = rect.height / 2;
                const mouseRelativeToCenter_X = mouseX - imageViewerCenterX;
                const mouseRelativeToCenter_Y = mouseY - imageViewerCenterY;
                currentPanX = mouseRelativeToCenter_X - (mouseRelativeToCenter_X - currentPanX) * (currentScale / oldScale);
                currentPanY = mouseRelativeToCenter_Y - (mouseRelativeToCenter_Y - currentPanY) * (currentScale / oldScale);
            }

            fullImageElement.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'default';
            fullImageElement.style.pointerEvents = currentScale > MIN_SCALE ? 'auto' : 'none';
            fullImageElement.style.transition = 'transform 0.05s ease-out';
            constrainPan();
            applyTransformations();
        }

        function handleMouseDownPan(event) {
            if (event.button !== 0 || currentScale <= MIN_SCALE || !fullImageElement) return;
            event.preventDefault();
            isPanningImage = true;
            lastPanMouseX = event.clientX;
            lastPanMouseY = event.clientY;
            fullImageElement.style.cursor = 'grabbing';
            fullImageElement.style.transition = 'none';
            imageViewer.style.userSelect = 'none';
        }

        function handleMouseMovePan(event) {
            if (!isPanningImage || !fullImageElement) return;
            event.preventDefault();
            const dX = event.clientX - lastPanMouseX, dY = event.clientY - lastPanMouseY;
            currentPanX += dX;
            currentPanY += dY;
            lastPanMouseX = event.clientX;
            lastPanMouseY = event.clientY;
            constrainPan();
            applyTransformations();
        }

        function handleMouseUpPan(event) {
            if (!isPanningImage) return;
            event.preventDefault();
            isPanningImage = false;
            if (fullImageElement) fullImageElement.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'default';
            if(imageViewer) imageViewer.style.userSelect = 'auto';
        }

        function resetZoomAndPan(apply = true) {
            currentScale = MIN_SCALE;
            currentPanX = 0;
            currentPanY = 0;
            if (fullImageElement) {
                fullImageElement.style.cursor = 'default';
                fullImageElement.style.pointerEvents = 'none';
                if(apply) fullImageElement.style.transition = 'transform 0.1s ease-out';
                if(apply) applyTransformations();
            }
        }

        function getDistance(touch1, touch2) {
            return Math.sqrt(Math.pow(touch2.clientX - touch1.clientX, 2) + Math.pow(touch2.clientY - touch1.clientY, 2));
        }

        function getMidpoint(touch1, touch2) {
            return { x: (touch1.clientX + touch2.clientX) / 2, y: (touch1.clientY + touch2.clientY) / 2 };
        }

        function handleTouchStart(event) {
            if (!fullImageElement) return;
            if (event.touches.length === 2) {
                event.preventDefault();
                initialPinchDistance = getDistance(event.touches[0], event.touches[1]);
                initialScale = currentScale;
                fullImageElement.style.transition = 'none';
                isTwoFingerPanning = true;
            } else if (event.touches.length === 1) {
                lastTouchX = event.touches[0].clientX;
                lastTouchY = event.touches[0].clientY;
                fullImageElement.style.transition = 'none';
                if (currentScale > MIN_SCALE) {
                    event.preventDefault();
                    isTwoFingerPanning = false;
                    fullImageElement.style.cursor = 'grabbing';
                } else {
                    touchstartX = event.changedTouches[0].screenX;
                    isTwoFingerPanning = false;
                }
            }
        }

        function handleTouchMove(event) {
            if (!fullImageElement) return;
            if (event.touches.length === 2) {
                event.preventDefault();
                const currentPinchDistance = getDistance(event.touches[0], event.touches[1]);
                let newScale = initialScale * (currentPinchDistance / initialPinchDistance);
                newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));

                const oldScale = currentScale;
                const oldMidpoint = getMidpoint(event.touches[0], event.touches[1]);
                const viewerRect = imageViewer.getBoundingClientRect();
                const imageViewerCenterX = viewerRect.width / 2, imageViewerCenterY = viewerRect.height / 2;

                const mouseRelativeToCenter_X = oldMidpoint.x - viewerRect.left - imageViewerCenterX;
                const mouseRelativeToCenter_Y = oldMidpoint.y - viewerRect.top - imageViewerCenterY;

                currentPanX = mouseRelativeToCenter_X - (mouseRelativeToCenter_X - currentPanX) * (currentScale / oldScale);
                currentPanY = mouseRelativeToCenter_Y - (mouseRelativeToCenter_Y - currentPanY) * (currentScale / oldScale);

                currentScale = newScale;
                constrainPan();
                applyTransformations();

                fullImageElement.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'default';
                fullImageElement.style.pointerEvents = currentScale > MIN_SCALE ? 'auto' : 'none';
                if (currentScale <= MIN_SCALE) resetZoomAndPan(false);
            } else if (event.touches.length === 1 && currentScale > MIN_SCALE) {
                event.preventDefault();
                const touch = event.touches[0];
                const dX = touch.clientX - lastTouchX, dY = touch.clientY - lastTouchY;
                currentPanX += dX;
                currentPanY += dY;
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
                constrainPan();
                applyTransformations();
                fullImageElement.style.cursor = 'grabbing';
                isTwoFingerPanning = false;
            }
        }

        function handleTouchEnd(event) {
            if (!fullImageElement) return;
            fullImageElement.style.transition = 'transform 0.05s ease-out';
            fullImageElement.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'default';
            if (event.changedTouches.length === 1 && currentScale <= MIN_SCALE && !isTwoFingerPanning) {
                touchendX = event.changedTouches[0].screenX;
                if(checkLength()) {
                    let dir = checkDirection() ? 1 : -1;
                    const currentImgName = fullImageElement.alt.replace('Full view of ', '');
                    const currentImgIndex = imgNames.indexOf(currentImgName);
                    if ((dir === 1 && currentImgIndex < imgNames.length - 1) || (dir === -1 && currentImgIndex > 0)) {
                        changeFull(imgNames[currentImgIndex + dir]);
                    }
                }
            }
            isTwoFingerPanning = false;
        }

        function updateFullViewThumbSelector(currentImgName) {
            const selectorContainer = document.getElementById('fullViewThumbSelector');
            if (!selectorContainer) return;
            selectorContainer.querySelectorAll('img').forEach(img => { img.classList.remove('activeFullViewThumb'); });
            const activeThumb = selectorContainer.querySelector(`img[alt="Thumbnail of ${currentImgName}"]`);
            if (activeThumb) {
                activeThumb.classList.add('activeFullViewThumb');
                activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        function createFullViewThumbSelector(currentImgName) {
            let selectorContainer = document.getElementById('fullViewThumbSelector');
            if (!selectorContainer) {
                selectorContainer = document.createElement('div');
                selectorContainer.id = 'fullViewThumbSelector';
                imageViewer.appendChild(selectorContainer);
            } else {
                selectorContainer.innerHTML = '';
            }
            imgNames.forEach(name => {
                let thumb = document.createElement('img');
                thumb.src = `./thumbs/${name}.jpg`;
                thumb.alt = `Thumbnail of ${name}`;
                thumb.onclick = function() { changeFull(name); };
                selectorContainer.appendChild(thumb);
            });
            updateFullViewThumbSelector(currentImgName);
        }

        function viewFull(imgName) {
            document.body.style.overflow = 'hidden';
            homeButton.hidden = true;
            if(titleElement) titleElement.classList.add('hidden');
            if(gallery) gallery.classList.add('pointer-events-none');
            
            madeFullscreen = doFullscreen && !document.fullscreenElement;
            if(madeFullscreen) document.body.requestFullscreen();

            const existingFullImg = document.getElementById('full');
            if (existingFullImg) existingImg.remove();

            const fullImg = new Image();
            fullImg.id = 'full';
            fullImg.src = `./${fullDir}/${imgName}.jpg`;
            fullImg.alt = `Full view of ${imgName}`;
            imageViewer.appendChild(fullImg);
            fullImageElement = fullImg;

            resetZoomAndPan(false);
            imageViewer.hidden = false;
            imageViewer.classList.add('visible');

            const existingThumbSelector = document.getElementById('fullViewThumbSelector');
            if (!existingThumbSelector || !existingThumbSelector.hasChildNodes()) {
                createFullViewThumbSelector(imgName);
            } else {
                updateFullViewThumbSelector(imgName);
            }

            const thumbSelector = document.getElementById('fullViewThumbSelector');
            const metadataViewer = document.getElementById('metadataViewer');
            const toggleThumbSelectorButton = document.getElementById('toggleThumbSelector');

            thumbSelector.classList.toggle('hidden-thumbs', !thumbSelectorVisible);
            fullImageElement.classList.toggle('thumbs-hidden', !thumbSelectorVisible);
            metadataViewer.classList.toggle('thumbs-hidden', !thumbSelectorVisible);
            toggleThumbSelectorButton.innerHTML = thumbSelectorVisible ? '⬇️' : '⬆️';

            const imgNameIndex = imgNames.indexOf(imgName);
            const leftArrow = document.getElementById('leftArrow');
            const rightArrow = document.getElementById('rightArrow');
            if (leftArrow) leftArrow.hidden = (imgNameIndex === 0 || isMobile);
            if (rightArrow) rightArrow.hidden = (imgNameIndex === imgNames.length - 1 || isMobile);

            viewMetadata(imgName);
            addViewerEventListeners();
        }

        function changeFull(newImgName) {
            if(fullImageElement) fullImageElement.removeEventListener('mousedown', handleMouseDownPan);
            const currentImg = fullImageElement;
            if (!currentImg) {
                console.error("Current full image element not found for transition. Calling viewFull instead.");
                viewFull(newImgName);
                return;
            }

            const currentImgName = currentImg.alt.replace('Full view of ', '');
            const currentImgIndex = imgNames.indexOf(currentImgName);
            const newImgIndex = imgNames.indexOf(newImgName);
            const direction = newImgIndex > currentImgIndex ? 1 : -1;
            currentImg.classList.add(direction === 1 ? 'slide-out-left' : 'slide-out-right');

            const newImage = new Image();
            newImage.id = 'full';
            newImage.src = `./${fullDir}/${newImgName}.jpg`;
            newImage.alt = `Full view of ${newImgName}`;
            newImage.classList.add(direction === 1 ? 'slide-in-right' : 'slide-in-left');
            
            imageViewer.appendChild(newImage);
            fullImageElement = newImage;
            resetZoomAndPan(false);
            if(fullImageElement) fullImageElement.addEventListener('mousedown', handleMouseDownPan);
            fullImageElement.classList.toggle('thumbs-hidden', !thumbSelectorVisible);

            setTimeout(() => {
                currentImg.remove();
                setTimeout(() => { newImage.classList.remove('slide-in-right', 'slide-in-left'); }, 300);
                updateFullViewThumbSelector(newImgName);
                viewMetadata(newImgName);

                const newImgIndexAfterChange = imgNames.indexOf(newImgName);
                const leftArrow = document.getElementById('leftArrow');
                const rightArrow = document.getElementById('rightArrow');
                if (leftArrow) leftArrow.hidden = (newImgIndexAfterChange === 0 || isMobile);
                if (rightArrow) rightArrow.hidden = (newImgIndexAfterChange === imgNames.length - 1 || isMobile);
            }, 300);
        }

        function exifToDate(exifTimestamp) {
            const [datePart, timePart] = exifTimestamp.split(' ');
            const [year, month, day] = datePart.split(':');
            const [hour, minute, second] = timePart.split(':');
            return new Date(year, month - 1, day, hour, minute, second);
        }

        function formatDate(date) {
            const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const dayOfWeek = daysOfWeek[date.getDay()];
            const month = months[date.getMonth()];
            const dayOfMonth = date.getDate();
            const year = date.getFullYear();
            const hours = date.getHours() % 12 || 12;
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = date.getHours() >= 12 ? 'PM' : 'AM';
            return `${dayOfWeek}, ${month} ${dayOfMonth}, ${year} @ ${hours}:${minutes} ${ampm}`;
        }

        // Helper function to convert GPS values (degrees, minutes, seconds) to decimal degrees
        function _convertDegrees(valueString) {
            // Regex to find numbers, including fractions like '252/5'
            const matches = valueString.match(/(\d+\s*\/\s*\d+|\d+(\.\d+)?)/g);

            if (!matches || matches.length < 3) {
                console.warn("Invalid GPS coordinate string format:", valueString);
                return NaN;
            }

            const parts = matches.map(s => {
                if (s.includes('/')) {
                    const [num, den] = s.split('/').map(Number);
                    return num / den;
                }
                return Number(s);
            });

            const d = parts[0];
            const m = parts[1];
            const s = parts[2];

            if (isNaN(d) || isNaN(m) || isNaN(s)) {
                console.warn("Parsed GPS components are NaN:", parts);
                return NaN;
            }

            return d + (m / 60.0) + (s / 3600.0);
        }

        // Function to get raw GPS coordinates (latitude, longitude)
        function getRawGpsCoordinates(imgData) {
            const lat = imgData['GPS GPSLatitude'];
            const lat_ref = imgData['GPS GPSLatitudeRef'];
            const lon = imgData['GPS GPSLongitude'];
            const lon_ref = imgData['GPS GPSLongitudeRef'];

            if (lat && lat_ref && lon && lon_ref) {
                let latitude = _convertDegrees(lat);
                if (lat_ref === 'S') {
                    latitude *= -1;
                }

                let longitude = _convertDegrees(lon);
                if (lon_ref === 'W') {
                    longitude *= -1;
                }

                if (!isNaN(latitude) && !isNaN(longitude)) {
                    return { latitude: latitude.toFixed(4), longitude: longitude.toFixed(4) };
                }
            }
            return null; // Return null if GPS data is not available or invalid
        }

        // Function to show the light pollution map in an iframe modal
        function showLightPollutionMap(lat, lon) {
            let overlay = document.getElementById('lightPollutionMapOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'lightPollutionMapOverlay';
                document.body.appendChild(overlay);

                let container = document.createElement('div');
                container.id = 'lightPollutionMapContainer';
                overlay.appendChild(container);

                let iframe = document.createElement('iframe');
                iframe.id = 'lightPollutionMapIframe';
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('scrolling', 'no');
                container.appendChild(iframe);

                let closeButton = document.createElement('button');
                closeButton.id = 'lightPollutionMapCloseButton';
                closeButton.innerHTML = '✖️';
                closeButton.onclick = hideLightPollutionMap;
                container.appendChild(closeButton);
            }

            const iframeSrc = `https://timothydo.me/astronomy/lightpollution/?lat=${lat}&lon=${lon}`;
            document.getElementById('lightPollutionMapIframe').src = iframeSrc;
            overlay.classList.add('visible');
        }

        // Function to hide the light pollution map iframe modal
        function hideLightPollutionMap() {
            let overlay = document.getElementById('lightPollutionMapOverlay');
            if (overlay) {
                overlay.classList.remove('visible');
                // Optionally clear iframe src to stop any ongoing processes
                document.getElementById('lightPollutionMapIframe').src = 'about:blank';
            }
        }

        function viewMetadata(imgName) {
            let metadataViewerEl = document.getElementById('metadataViewer');
            if (!metadataViewerEl) return;
            let imgData = metadata[imgName]; 
            let htmlContent = '';

            if (!imgData) {
                console.warn("No metadata found for image:", imgName);
                htmlContent = `<h2>${imgName}.jpg</h2><p>No metadata available.</p>`;
            } else {
                let cameraModel = imgData['Image Model'] || 'N/A';
                let captureDate = imgData['Image DateTime'] ? exifToDate(imgData['Image DateTime']) : 'N/A';
                let width = imgData['Image Width'] || 'N/A';
                let height = imgData['Image Height'] || 'N/A';
                let resolution = (width !== 'N/A' && height !== 'N/A') ? (parseFloat(width)*parseFloat(height)/(10**6)).toFixed(1) : 'N/A';
                let fileSizeMB = imgData['File Size'] ? (parseFloat(imgData['File Size'])/(1000**2)).toFixed(2) : 'N/A';
                let ISO = imgData['EXIF ISOSpeedRatings'] ? String(eval(imgData['EXIF ISOSpeedRatings'])) : 'N/A';
                let exposureTimeRaw = imgData['EXIF ExposureTime'] ? eval(imgData['EXIF ExposureTime']) : 'N/A';
                let exposureTime = exposureTimeRaw !== 'N/A' ? (exposureTimeRaw < 0.1 && exposureTimeRaw !== 0 ? `1/${Math.round(1/exposureTimeRaw)}` : exposureTimeRaw) : 'N/A';
                let fNumber = imgData['EXIF FNumber'] ? String(eval(imgData['EXIF FNumber'])) : 'N/A';
                let focalLength35 = imgData['EXIF FocalLengthIn35mmFilm'] ? String(eval(imgData['EXIF FocalLengthIn35mmFilm'])) : 'N/A';
                let ev = imgData['EXIF ExposureBiasValue'] ? String(eval(imgData['EXIF ExposureBiasValue'])) : 'N/A';
                
                let gpsCoords = getRawGpsCoordinates(imgData);
                let gpsCoordinatesDisplay;

                if (gpsCoords) {
                    gpsCoordinatesDisplay = `<span style="cursor: pointer; text-decoration: underline;" onclick="showLightPollutionMap(${gpsCoords.latitude}, ${gpsCoords.longitude})">${gpsCoords.latitude}, ${gpsCoords.longitude}</span>`;
                } else {
                    gpsCoordinatesDisplay = 'N/A';
                }

                htmlContent += `<h2>${imgName}.jpg</h2>`;
                htmlContent += `<p>🗓️: ${captureDate !== 'N/A' ? formatDate(captureDate) : 'N/A'}</p>`; // Added colon
                htmlContent += `<p>📍: ${gpsCoordinatesDisplay}</p>`; // Hardcoded pin emoji and reordered
                htmlContent += `<p>📷: ${cameraModel}</p>`;
                htmlContent += `<p>${fileSizeMB} MB | ${width}x${height} | ${resolution} MP</p>`;
                htmlContent += `<p>ISO ${ISO} | ${focalLength35}mm | ${ev}ev | F${fNumber} | ${exposureTime}" s</p>`;
            }
            metadataViewerEl.innerHTML = htmlContent;
        }

        function toggleMetadata() {
            let metadataViewerEl = document.getElementById('metadataViewer');
            if (metadataViewerEl) metadataViewerEl.classList.toggle('active');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                if (imageViewer.requestFullscreen) imageViewer.requestFullscreen();
                else if (imageViewer.mozRequestFullScreen) imageViewer.mozRequestFullScreen();
                else if (imageViewer.webkitRequestFullscreen) imageViewer.webkitRequestFullscreen();
                else if (imageViewer.msRequestFullscreen) imageViewer.msRequestFullscreen();
                madeFullscreen = true;
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
                madeFullscreen = false;
            }
        }

        function toggleThumbSelector() {
            const thumbSelector = document.getElementById('fullViewThumbSelector');
            const fullImage = document.getElementById('full');
            const metadataViewer = document.getElementById('metadataViewer');
            const toggleThumbSelectorButton = document.getElementById('toggleThumbSelector');

            if (thumbSelector && fullImage && metadataViewer && toggleThumbSelectorButton) {
                thumbSelectorVisible = !thumbSelectorVisible;
                thumbSelector.classList.toggle('hidden-thumbs', !thumbSelectorVisible);
                fullImage.classList.toggle('thumbs-hidden', !thumbSelectorVisible);
                metadataViewer.classList.toggle('thumbs-hidden', !thumbSelectorVisible);
                toggleThumbSelectorButton.innerHTML = thumbSelectorVisible ? '⬇️' : '⬆️';
            }
        }

        function goHome() { window.location.href = "../index.html"; }
        const dblClickHandler = () => resetZoomAndPan(true);

        function exitView() {
            removeViewerEventListeners();
            // Only show home button if not in an iframe
            if (window.self === window.top) {
                homeButton.hidden = false;
            }

            // Close the light pollution map iframe if it's open
            hideLightPollutionMap();

            if(document.fullscreenElement && madeFullscreen) {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
            }
            madeFullscreen = false;
            imageViewer.classList.add('shrinking');

            setTimeout(() => {
                document.body.style.overflow = 'auto';
                if(gallery) gallery.classList.remove('pointer-events-none');
                if(titleElement) titleElement.classList.remove('hidden');
                imageViewer.hidden = true;
                imageViewer.classList.remove('visible', 'shrinking');
                const full = document.getElementById('full');
                if(full) full.remove();
                fullImageElement = null;

                thumbSelectorVisible = true;
                if (document.getElementById('fullViewThumbSelector')) document.getElementById('fullViewThumbSelector').classList.remove('hidden-thumbs');
                if (document.getElementById('metadataViewer')) document.getElementById('metadataViewer').classList.remove('thumbs-hidden');
                if (document.getElementById('full')) document.getElementById('full').classList.remove('thumbs-hidden');
                if (document.getElementById('toggleThumbSelector')) document.getElementById('toggleThumbSelector').innerHTML = '⬇️';
            }, 300);
        }

        function fillTitle() {
            if (!titleElement) return;
            if(j < completedTitle.length) {
                titleElement.innerHTML += completedTitle[j];
                j++;
            } else {
                 clearInterval(titleInterval);
            }
        }

        function viewGallery() {
            if(galleryCounter === 0) viewFull(imgNames[galleryCounter]);
            else if(galleryCounter < imgNames.length) changeFull(imgNames[galleryCounter]);
            else { galleryCounter = 0; changeFull(imgNames[galleryCounter]); }
            galleryCounter++;
        }
        
        function addViewerEventListeners() {
            if(fullImageElement) fullImageElement.addEventListener('mousedown', handleMouseDownPan);
            imageViewer.addEventListener('wheel', handleWheelZoom, { passive: false });
            imageViewer.addEventListener('dblclick', dblClickHandler);
            document.addEventListener('mousemove', handleMouseMovePan);
            document.addEventListener('mouseup', handleMouseUpPan);
            document.addEventListener('keydown', keyAction);
            imageViewer.addEventListener('touchstart', handleTouchStart, { passive: false });
            imageViewer.addEventListener('touchmove', handleTouchMove, { passive: false });
            imageViewer.addEventListener('touchend', handleTouchEnd);
            document.getElementById('fullscreenToggle').addEventListener('click', toggleFullscreen);
            document.getElementById('toggleThumbSelector').addEventListener('click', toggleThumbSelector);
        }

        function removeViewerEventListeners() {
            if(fullImageElement) fullImageElement.removeEventListener('mousedown', handleMouseDownPan);
            imageViewer.removeEventListener('wheel', handleWheelZoom);
            imageViewer.removeEventListener('dblclick', dblClickHandler);
            document.removeEventListener('mousemove', handleMouseMovePan);
            document.removeEventListener('mouseup', handleMouseUpPan);
            document.removeEventListener('keydown', keyAction);
            imageViewer.removeEventListener('touchstart', handleTouchStart);
            imageViewer.removeEventListener('touchmove', handleTouchMove);
            imageViewer.removeEventListener('touchend', handleTouchEnd);
            document.getElementById('fullscreenToggle').removeEventListener('click', toggleFullscreen);
            document.getElementById('toggleThumbSelector').removeEventListener('click', toggleThumbSelector);
        }

        window.onload = function() {
            if(preload) preloadFulls();
            gallery = document.getElementById('gallery');
            imageViewer = document.getElementById('imageViewer');
            titleElement = document.getElementById('title'); 
            homeButton = document.getElementById('home');
            isMobile = isMobileDevice();
            loadMetadata();

            const cleanedTitle = completedTitle.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '');
            document.title = cleanedTitle;

            imageViewer.innerHTML = `
                <button id="exitViewer" onclick="exitView()">✖️</button>
                <button id="toggleMetadata" onclick="toggleMetadata()">ℹ️</button>
                <button id="fullscreenToggle"> ⛶</button>
                <button id="toggleThumbSelector"> ⬇️</button>
                <div id="metadataViewer"></div>
                <button id="leftArrow">❮</button>
                <button id="rightArrow">❯</button>
                <div id="fullViewThumbSelector"></div>
            `;
            
            document.getElementById('leftArrow').onclick = () => {
                const currentImgName = fullImageElement.alt.replace('Full view of ', '');
                const currentImgIndex = imgNames.indexOf(currentImgName);
                if (currentImgIndex > 0) changeFull(imgNames[currentImgIndex - 1]);
            };
            document.getElementById('rightArrow').onclick = () => {
                const currentImgName = fullImageElement.alt.replace('Full view of ', '');
                const currentImgIndex = imgNames.indexOf(currentImgName);
                if (currentImgIndex < imgNames.length - 1) changeFull(imgNames[currentImgIndex + 1]);
            };

            if(galleryView) {
                doFullscreen = false;
                galleryInterval = setInterval(viewGallery,galleryDuration);
            }
            else {
                loadThumbs();
                revealInterval = setInterval(revealThumbs,25);
            }
            if (titleElement) {
               titleInterval = setInterval(fillTitle,25);
            } else {
                console.warn("Title element 'title' not found.");
            }

            keyAction = function(e) {
                if (!imageViewer.hidden) {
                    if (!fullImageElement) return;
                    const currentImgName = fullImageElement.alt.replace('Full view of ', '');
                    const currentImgIndex = imgNames.indexOf(currentImgName);

                    if (e.code === "ArrowLeft") {
                        if (currentImgIndex > 0) changeFull(imgNames[currentImgIndex - 1]);
                    } else if (e.code === "ArrowRight") {
                        if (currentImgIndex < imgNames.length - 1) changeFull(imgNames[currentImgIndex + 1]);
                    } else if (e.code === "Escape") {
                        if (currentScale > MIN_SCALE) resetZoomAndPan(true);
                        else exitView();
                    } else if (e.code === "KeyI") {
                        toggleMetadata();
                    } else if (e.code === "KeyF") {
                        toggleFullscreen();
                    } else if (e.code === "KeyT") {
                        toggleThumbSelector();
                    }
                }
            };

            // Check if the page is in an iframe and hide the home button if it is
            if (window.self !== window.top) {
                homeButton.hidden = true;
            }
        };

        document.addEventListener('fullscreenchange', function(e) {
            if(!document.fullscreenElement && madeFullscreen) exitView();
            if(document.fullscreenElement && !madeFullscreen) madeFullscreen = true;
        });
    </script>
    <body>
        <h1 id="title"></h1>
        <div id="gallery"></div>
        <div hidden id="imageViewer"></div>
    </body>

    <footer hidden>
        <h2>© <a href="https://timothydo.me">Timothy Do</a> 2024. All Rights Reserved.</h2>
        <button id="home" onclick="goHome()">🏠</button>
    </footer>

</html>
